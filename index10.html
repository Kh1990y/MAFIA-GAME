<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAFIA: COSA NOSTRA PRESTIGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --accent: #d4af37; --mafia: #ff4444; }
        body { font-family: 'Cairo', sans-serif; background: #050505; color: #fff; margin: 0; overflow-x: hidden; }
        
        /* Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‚Ø³Ù… */
        .lobby-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; height: calc(100vh - 120px); }
        @media (max-width: 768px) { .lobby-grid { grid-template-columns: 1fr; height: auto; overflow-y: visible; } }

        .bg-auth { background: url('https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExMHJ3mXprbGZ1a2U2Zm5pZGtwdjVhampseHQ5bmw3NmRndjI3a3IwaiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/JUwa2qSoTwcxv0gFJh/giphy.gif') center/cover no-repeat; }
        .bg-night { background: url('https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3ppcjh1djJtdXhocXd0anBoc251cnFieXlmM3Y3bTh5b2k5aGFmaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rzeWnbH8Uc5Y4/giphy.gif') center/cover no-repeat; }
        .bg-day { background: url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3ppcjh1djJtdXhocXd0anBoc251cnFieXlmM3Y3bTh5b2k5aGFmaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rzeWnbH8Uc5Y4/giphy.gif') center/cover no-repeat; opacity: 0.8; }
        
        .glass { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 20px; }
        .screen { display: none; min-height: 100dvh; padding: 20px; flex-direction: column; position: relative; z-index: 10; width: 100%; max-width: 1200px; margin: 0 auto; }
        .screen.active { display: flex; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ø±Ø¯Ø² Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .role-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: 2px solid transparent; background: #1a1a1a; position: relative; overflow: hidden; }
        .role-card.active.mafia-card { background: #4a0000; border-color: #ff4444; box-shadow: 0 0 20px rgba(255, 68, 68, 0.4); }
        .role-card.active.doctor-card { background: #003311; border-color: #00ff66; box-shadow: 0 0 20px rgba(0, 255, 102, 0.4); }
        .role-card.active.detective-card { background: #001a33; border-color: #0099ff; box-shadow: 0 0 20px rgba(0, 153, 255, 0.4); }
        .role-card.active.joker-card { background: #1a0033; border-color: #aa00ff; box-shadow: 0 0 20px rgba(170, 0, 255, 0.4); }
        .role-card.active.auth-card { background: #332200; border-color: #d4af37; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .role-card.disabled { opacity: 0.3; filter: grayscale(0.8); }

        .user-identity-bar { background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent); border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding: 10px; text-align: center; font-weight: 900; color: var(--accent); font-size: 12px; }
        .btn-premium { background: linear-gradient(135deg, #d4af37, #aa891f); color: #000; font-weight: 900; border-radius: 12px; transition: 0.3s; }
        .btn-premium:active { transform: scale(0.95); }
        
        #system-alert { position: fixed; inset: 0; z-index: 5000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); }
        .alert-card { width: 90%; max-width: 350px; padding: 40px 20px; text-align: center; border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
    </style>
</head>
<body class="bg-auth">

<div id="system-alert">
    <div class="alert-card glass">
        <div id="alert-icon" class="mb-4 flex justify-center text-accent"></div>
        <h2 id="alert-text" class="text-2xl font-black text-white mb-2 italic"></h2>
        <div class="w-12 h-0.5 bg-accent mx-auto mb-4"></div>
        <p id="alert-sub" class="text-gray-300 font-bold text-sm"></p>
    </div>
</div>

<div class="h-full relative">
    <section id="screen-auth" class="screen active justify-center max-w-md">
        <div class="glass p-8 text-center">
            <h1 class="text-3xl font-black mb-8 tracking-widest text-accent italic">COSA NOSTRA</h1>
            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none">
                <input type="text" id="room-id" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none">
                <div class="grid grid-cols-2 gap-3 pt-4">
                    <button onclick="handleJoin()" class="bg-white/5 border border-white/10 p-4 rounded-xl font-bold">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                    <button onclick="handleCreate()" class="btn-premium p-4">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-lobby" class="screen">
        <div class="flex justify-between items-center mb-8 bg-black/40 p-4 rounded-2xl border border-white/5">
            <div>
                <p class="text-[9px] text-accent font-black uppercase">Session ID</p>
                <h2 id="display-room-id" class="text-2xl font-black tracking-widest">----</h2>
            </div>
            <div id="player-count" class="bg-accent text-black px-4 py-1 rounded-full text-[10px] font-black">0 PLAYERS</div>
        </div>

        <div class="lobby-grid">
            <div class="flex flex-col">
                <h3 class="text-accent text-xs font-black mb-4 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                <div id="lobby-list" class="space-y-2 overflow-y-auto pr-2"></div>
            </div>

            <div class="flex flex-col">
                <h3 class="text-accent text-xs font-black mb-4 flex items-center gap-2"><i data-lucide="shield" class="w-4 h-4"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
                <div id="role-selection-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                    </div>
                
                <div id="host-settings" class="hidden glass p-4 mb-4">
                    <button id="start-btn" onclick="startGame()" class="btn-premium w-full py-4 font-black uppercase">Start Operation</button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-role" class="screen justify-center items-center">
        <div class="alert-card glass !opacity-100">
            <i data-lucide="shield-check" class="mx-auto mb-4 text-accent w-12 h-12"></i>
            <h2 id="role-title" class="text-4xl font-black mb-2 uppercase text-white">---</h2>
            <p id="role-desc" class="text-accent text-xs font-bold px-4"></p>
        </div>
    </section>

    <section id="screen-game" class="screen !p-0 max-w-full">
        <div id="player-identity-header" class="user-identity-bar uppercase italic">--</div>
        <div class="p-4 glass !rounded-none !border-0 !border-b border-white/10 flex justify-between items-center">
            <div><h3 id="phase-title" class="font-black text-sm">---</h3><p id="turn-indicator" class="text-[8px] text-accent font-black"></p></div>
            <div id="role-badge" class="px-3 py-1 bg-accent text-black rounded text-[8px] font-black uppercase">--</div>
        </div>
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
        <div class="p-4 glass !rounded-none bg-black/90">
            <div id="action-grid" class="grid grid-cols-2 gap-2 mb-3"></div>
            <div class="flex gap-2 bg-white/5 p-2 rounded-xl">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-transparent px-2 outline-none text-white text-xs">
                <button onclick="sendMessage()" class="bg-accent text-black w-10 h-10 rounded-lg flex items-center justify-center"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
    </section>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCgc3oYJOrdOV9Y22x7MzBUEJSGGXsfXUU",
        authDomain: "mafia-game-7dc88.firebaseapp.com",
        databaseURL: "https://mafia-game-7dc88-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "mafia-game-7dc88",
        storageBucket: "mafia-game-7dc88.firebasestorage.app",
        messagingSenderId: "776724825938",
        appId: "1:776724825938:web:afab585356cb94f9a15c8b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let local = { 
        id: '', name: '', role: '', isAlive: true, isHost: false, 
        room: '', phase: '', actionTaken: false, investigated: [], 
        usedHealList: [], authPowerUsed: false, lastProcessedPhase: '',
        selectedRoles: ['Doctor', 'Detective', 'Joker', 'Authority'],
        mafiaCount: 1
    };

    const ROLE_CONFIG = {
        'Mafia': { name: 'Ø§Ù„Ù…Ø§ÙÙŠØ§', icon: 'skull', class: 'mafia-card', desc: 'Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¶Ø§Ø±Ø¨Ø©ØŒ ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¨Ø­Ø°Ø±.' },
        'Doctor': { name: 'Ø§Ù„Ø·Ø¨ÙŠØ¨', icon: 'heart-pulse', class: 'doctor-card', desc: 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆØª Ø§Ù„Ù„Ø­Ø¸ÙŠ.' },
        'Detective': { name: 'Ø§Ù„Ù…Ø­Ù‚Ù‚', icon: 'search', class: 'detective-card', desc: 'ÙƒØ´Ù Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ÙˆÙØ¶Ø­ Ø§Ù„Ù…Ø§ÙÙŠØ§.' },
        'Joker': { name: 'Ø§Ù„Ø¬ÙˆÙƒÙŠØ±', icon: 'dices', class: 'joker-card', desc: 'Ø§Ù„ÙÙˆØ¶Ù‰ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©ØŒ ØªØºÙŠÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯ÙˆØ§Ø±.' },
        'Authority': { name: 'Ø§Ù„Ø³Ù„Ø·Ø©', icon: 'gavel', class: 'auth-card', desc: 'ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª.' }
    };

    function renderRoleSelection(dataSettings) {
        const container = document.getElementById('role-selection-container');
        container.innerHTML = '';
        
        // 1. ÙƒØ§Ø±Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§ Ù…Ø¹ Ø§Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
        const mActive = true;
        const mCard = document.createElement('div');
        mCard.className = `role-card active mafia-card p-4 rounded-xl flex flex-col justify-between h-32`;
        mCard.innerHTML = `
            <div class="flex justify-between items-start">
                <i data-lucide="skull" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase">Ø§Ù„Ù…Ø§ÙÙŠØ§</span>
            </div>
            <div class="mt-2">
                <p class="text-[9px] opacity-70 mb-2">${ROLE_CONFIG['Mafia'].desc}</p>
                <div class="flex items-center gap-3 bg-black/40 p-1 rounded-lg w-fit">
                    ${local.isHost ? `
                        <button onclick="changeMafia(-1)" class="w-6 h-6 bg-red-500/20 rounded">-</button>
                        <span id="m-count-val" class="text-xs font-bold">${local.mafiaCount}</span>
                        <button onclick="changeMafia(1)" class="w-6 h-6 bg-red-500/20 rounded">+</button>
                    ` : `<span class="px-2 text-xs">Ø§Ù„Ø¹Ø¯Ø¯: ${dataSettings?.mafiaCount || 1}</span>`}
                </div>
            </div>
        `;
        container.appendChild(mCard);

        // 2. Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        ['Doctor', 'Detective', 'Joker', 'Authority'].forEach(roleKey => {
            const conf = ROLE_CONFIG[roleKey];
            const isActive = local.selectedRoles.includes(roleKey);
            const card = document.createElement('div');
            card.className = `role-card ${isActive ? 'active ' + conf.class : 'disabled'} p-4 rounded-xl flex flex-col justify-between h-32`;
            if(local.isHost) card.onclick = () => toggleRole(roleKey);
            
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <i data-lucide="${conf.icon}" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black uppercase">${conf.name}</span>
                </div>
                <p class="text-[9px] opacity-70">${conf.desc}</p>
                ${isActive ? '<div class="text-[8px] font-bold text-white/50">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø®Ø¯Ù…Ø©</div>' : ''}
            `;
            container.appendChild(card);
        });
        lucide.createIcons();
    }

    function changeMafia(val) {
        event.stopPropagation();
        let newCount = local.mafiaCount + val;
        if(newCount < 1) newCount = 1;
        if(newCount > 4) newCount = 4;
        local.mafiaCount = newCount;
        db.ref(`games/${local.room}/settings`).update({ mafiaCount: newCount });
    }

    function toggleRole(role) {
        if(local.selectedRoles.includes(role)) {
            local.selectedRoles = local.selectedRoles.filter(r => r !== role);
        } else {
            local.selectedRoles.push(role);
        }
        db.ref(`games/${local.room}/settings`).update({ selectedRoles: local.selectedRoles });
    }

    // --- GAME LOGIC (KEPT INTACT) ---
    function showSystemCard(title, sub, iconName = "bell") {
        const overlay = document.getElementById('system-alert');
        const card = overlay.querySelector('.alert-card');
        document.getElementById('alert-text').innerText = title;
        document.getElementById('alert-sub').innerText = sub;
        document.getElementById('alert-icon').innerHTML = `<i data-lucide="${iconName}" class="w-12 h-12"></i>`;
        lucide.createIcons();
        overlay.style.display = 'flex';
        setTimeout(() => { overlay.style.display = 'none'; }, 4000);
    }

    function navigate(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        lucide.createIcons();
    }

    function handleCreate() {
        const name = document.getElementById('user-name').value.trim();
        if(!name) return;
        local.room = Math.floor(1000 + Math.random() * 9000).toString();
        local.id = 'p_' + Date.now(); local.name = name; local.isHost = true;
        db.ref(`games/${local.room}`).set({ 
            status: 'lobby', host: local.id,
            settings: { selectedRoles: local.selectedRoles, mafiaCount: 1 },
            players: { [local.id]: { name, isAlive: true, role: '' } } 
        }).then(listen);
    }

    function handleJoin() {
        const name = document.getElementById('user-name').value.trim();
        const rId = document.getElementById('room-id').value.trim();
        if(!name || !rId) return;
        local.room = rId; local.name = name;
        db.ref(`games/${rId}`).once('value', snap => {
            if(!snap.exists()) return;
            const data = snap.val();
            local.id = Object.keys(data.players).find(k => data.players[k].name === name) || 'p_' + Date.now();
            local.isHost = (data.host === local.id);
            db.ref(`games/${rId}/players/${local.id}`).update({ name, isAlive: true });
            listen();
        });
    }

    function listen() {
        document.getElementById('display-room-id').innerText = local.room;
        db.ref(`games/${local.room}`).on('value', snap => {
            const data = snap.val(); if(!data) return;

            if(data.status === 'lobby') {
                if(data.settings) {
                    local.selectedRoles = data.settings.selectedRoles || [];
                    local.mafiaCount = data.settings.mafiaCount || 1;
                }
                renderRoleSelection(data.settings);
                const ps = Object.values(data.players);
                document.getElementById('lobby-list').innerHTML = ps.map(p => `
                    <div class="glass p-4 flex justify-between items-center border-white/5">
                        <span class="font-bold flex items-center gap-2 text-sm"><i data-lucide="user" class="w-3 h-3 text-accent"></i> ${p.name}</span>
                        <span class="text-[9px] text-white/30 uppercase tracking-tighter">Verified Player</span>
                    </div>
                `).join('');
                document.getElementById('player-count').innerText = ps.length + " PLAYERS";
                if(local.isHost && ps.length >= 4) document.getElementById('host-settings').classList.remove('hidden');
                navigate('screen-lobby');
            }

            if(data.status === 'assigning') {
                const me = data.players[local.id];
                if(me?.role && local.role !== me.role) {
                    local.role = me.role;
                    updateUIForRole(local.role);
                    navigate('screen-role');
                    setTimeout(() => navigate('screen-game'), 6000);
                }
            }

            if(data.status === 'night' || data.status === 'day') {
                const myCurrentData = data.players[local.id];
                if (myCurrentData && myCurrentData.role !== local.role) {
                    local.role = myCurrentData.role;
                    updateUIForRole(local.role);
                }
                if(local.phase !== data.status) {
                    local.phase = data.status; local.actionTaken = false;
                    document.body.className = (data.status === 'night' ? 'bg-night' : 'bg-day');
                }
                local.isAlive = data.players[local.id].isAlive;
                renderGame(data);
                if(local.isHost) checkLoop(data);
                checkWin(data);
            }

            if(data.status === 'result') {
                showSystemCard("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©", "Ø§Ù†ØªØµØ§Ø± " + data.winner, "trophy");
                setTimeout(() => location.reload(), 8000);
            }
            if(data.messages) renderMsgs(data.messages);
        });
    }

    function updateUIForRole(role) {
        const rName = translateRole(role);
        document.getElementById('role-title').innerText = rName;
        document.getElementById('player-identity-header').innerText = local.name + " | " + rName;
        document.getElementById('role-badge').innerText = rName;
        document.getElementById('role-desc').innerText = getRoleDesc(role);
    }

    function renderGame(data) {
        const grid = document.getElementById('action-grid');
        grid.innerHTML = '';
        if(!local.isAlive) return;
        if(local.actionTaken) {
            document.getElementById('turn-indicator').innerText = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø±Ø§Ø±Ùƒ Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©";
            return;
        }

        const aliveIds = Object.keys(data.players).filter(id => data.players[id].isAlive);

        if(data.status === 'night') {
            document.getElementById('phase-title').innerText = "Ù„ÙŠÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª";
            if(local.role === 'Joker') grid.innerHTML += `<button onclick="jokerPower()" class="col-span-2 p-3 bg-purple-900 border border-purple-500 rounded-xl text-[10px] font-black animate-pulse">ğŸƒ Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</button>`;
            aliveIds.forEach(id => {
                const p = data.players[id];
                if(local.role === 'Mafia' && p.role !== 'Mafia') grid.innerHTML += `<button onclick="db.ref('games/${local.room}/nightVotes/${local.id}').set('${id}')" class="bg-red-900/40 border border-red-500 p-3 text-[10px] rounded-xl">Ø§ØºØªÙŠØ§Ù„ ${p.name}</button>`;
                else if(local.role === 'Doctor' && !local.usedHealList.includes(id)) grid.innerHTML += `<button onclick="doctorAction('${id}')" class="bg-emerald-900/40 border border-emerald-500 p-3 text-[10px] rounded-xl">Ø­Ù…Ø§ÙŠØ© ${p.name}</button>`;
                else if(local.role === 'Detective' && id !== local.id && !local.investigated.includes(id)) grid.innerHTML += `<button onclick="investigateAction('${id}', '${p.name}', '${p.role}')" class="bg-blue-900/40 border border-blue-500 p-3 text-[10px] rounded-xl">ÙƒØ´Ù ${p.name}</button>`;
            });
        } else {
            document.getElementById('phase-title').innerText = "Ù†Ù‡Ø§Ø± Ø§Ù„Ù†Ù‚Ø§Ø´";
            if(local.role === 'Authority' && !local.authPowerUsed) {
                grid.innerHTML += `<button onclick="handleDayVote('${local.id}')" class="col-span-2 p-3 bg-amber-900 border border-amber-500 rounded-xl text-[10px]">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù…Ø·Ù„Ù‚</button>`;
            }
            aliveIds.forEach(id => {
                grid.innerHTML += `<button onclick="handleDayVote('${id}')" class="bg-white/5 border border-white/10 p-3 text-[10px] rounded-xl">${data.players[id].name}</button>`;
            });
            grid.innerHTML += `<button onclick="handleDayVote('skip')" class="col-span-2 border border-accent/30 p-3 text-[10px] rounded-xl text-accent">ØªØ®Ø·ÙŠ Ø§Ù„ØªØµÙˆÙŠØª</button>`;
        }
    }

    function handleDayVote(tid) {
        local.actionTaken = true;
        db.ref(`games/${local.room}/dayVotes/${local.id}`).set({target: tid, isSuperVote: (local.role === 'Authority' && tid === local.id)});
    }

    function jokerPower() { local.actionTaken = true; db.ref(`games/${local.room}/players/${local.id}`).update({ role: 'Citizen' }); db.ref(`games/${local.room}/nightActions/joker`).set(true); }
    function doctorAction(tid) { local.actionTaken = true; local.usedHealList.push(tid); db.ref(`games/${local.room}/nightActions/heal`).set(tid); }
    function investigateAction(id, name, role) { local.actionTaken = true; local.investigated.push(id); const res = (role === 'Mafia') ? "Ù…Ø§ÙÙŠØ§ ğŸ’€" : "ØµØ§Ù„Ø­ âœ…"; showSystemCard(`Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚`, `${name} Ù‡Ùˆ ${res}`, "search"); db.ref(`games/${local.room}/nightActions/detective`).set(true); }

    function startGame() {
        db.ref(`games/${local.room}`).once('value', s => {
            const data = s.val();
            const ids = Object.keys(data.players);
            let roles = [];
            for(let i=0; i< (data.settings.mafiaCount || 1); i++) roles.push('Mafia');
            (data.settings.selectedRoles || []).forEach(r => roles.push(r));
            while(roles.length < ids.length) roles.push('Citizen');
            roles = roles.slice(0, ids.length).sort(() => Math.random() - 0.5);
            const up = { status: 'assigning' };
            ids.forEach((id, i) => up[`players/${id}/role`] = roles[i]);
            db.ref(`games/${local.room}`).update(up).then(() => { 
                setTimeout(() => db.ref(`games/${local.room}`).update({ status: 'night', phaseId: Date.now() }), 6000); 
            });
        });
    }

    // --- SAME SYSTEM FUNCTIONS ---
    function checkLoop(data) {
        if (!local.isHost || data.phaseId === local.lastProcessedPhase) return;
        const alivePlayers = Object.entries(data.players).filter(e => e[1].isAlive);
        const aliveIds = alivePlayers.map(e => e[0]);
        if (data.status === 'night' && data.nightActions?.joker === true) {
            let roles = alivePlayers.map(e => e[1].role).sort(() => Math.random() - 0.5);
            let up = { "nightActions/joker": "done" };
            aliveIds.forEach((id, i) => up[`players/${id}/role`] = roles[i]);
            db.ref(`games/${local.room}`).update(up);
            broadcastEvent("Ø§Ù„Ø¬ÙˆÙƒÙŠØ±", "ØªÙ… Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±!", "dices");
            return;
        }
        if(data.status === 'night') {
            const votes = data.nightVotes ? Object.entries(data.nightVotes) : [];
            if(votes.length >= (data.settings.mafiaCount || 1)) {
                local.lastProcessedPhase = data.phaseId;
                const target = votes[0][1];
                if(target !== 'skip' && target !== data.nightActions?.heal) db.ref(`games/${local.room}/players/${target}`).update({ isAlive: false });
                db.ref(`games/${local.room}`).update({ status: 'day', phaseId: Date.now(), nightVotes: null, nightActions: null });
            }
        } else if(data.status === 'day') {
            const vtsRaw = data.dayVotes ? Object.entries(data.dayVotes) : [];
            if(vtsRaw.length >= aliveIds.length) {
                local.lastProcessedPhase = data.phaseId;
                const voted = vtsRaw[0][1].target;
                if(voted !== 'skip') db.ref(`games/${local.room}/players/${voted}`).update({ isAlive: false });
                db.ref(`games/${local.room}`).update({ status: 'night', phaseId: Date.now(), dayVotes: null });
            }
        }
    }

    function checkWin(data) {
        if (!local.isHost) return;
        const ps = Object.values(data.players);
        const m = ps.filter(x => x.isAlive && x.role === 'Mafia').length;
        const c = ps.filter(x => x.isAlive && x.role !== 'Mafia').length;
        if(m === 0 && data.status !== 'lobby') db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†' });
        else if(m >= c && data.status !== 'assigning' && data.status !== 'lobby') db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Ø§Ù„Ù…Ø§ÙÙŠØ§' });
    }

    function broadcastEvent(title, sub, icon) {
        showSystemCard(title, sub, icon);
        db.ref(`games/${local.room}/messages`).push({ text: `${title}: ${sub}`, type: 'system', cardTitle: title, cardSub: sub, cardIcon: icon, time: Date.now() });
    }

    function sendMessage() {
        const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
        let type = local.isAlive ? (local.phase === 'night' && local.role === 'Mafia' ? 'mafia' : 'player') : 'ghost';
        db.ref(`games/${local.room}/messages`).push({ sender: local.name, text: txt, type, senderId: local.id, time: Date.now() });
        inp.value = '';
    }

    function renderMsgs(msgs) {
        const box = document.getElementById('chat-box'); box.innerHTML = '';
        Object.values(msgs).forEach(m => {
            if(m.type === 'system' && m.time > (Date.now() - 5000)) showSystemCard(m.cardTitle, m.cardSub, m.cardIcon);
            if(m.type === 'mafia' && local.role !== 'Mafia' && local.isAlive) return;
            if(m.type === 'ghost' && local.isAlive) return;
            const div = document.createElement('div');
            if(m.type === 'system') { div.className = "text-center text-[9px] text-accent/60 my-2"; div.innerText = "ğŸ“¢ " + m.text; }
            else { div.className = `msg ${m.senderId === local.id ? 'msg-me' : 'msg-player'}`; div.innerHTML = `<span class="text-[8px] opacity-50 block">${m.sender}</span>${m.text}`; }
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    function translateRole(r) { return {'Mafia': 'Ø§Ù„Ù…Ø§ÙÙŠØ§', 'Doctor': 'Ø§Ù„Ø·Ø¨ÙŠØ¨', 'Detective': 'Ø§Ù„Ù…Ø­Ù‚Ù‚', 'Citizen': 'Ù…ÙˆØ§Ø·Ù†', 'Joker': 'Ø§Ù„Ø¬ÙˆÙƒÙŠØ±', 'Authority': 'Ø§Ù„Ø³Ù„Ø·Ø©'}[r] || r; }
    function getRoleDesc(r) { return {'Mafia': 'ØµÙÙŠ Ø£Ù‡Ø¯Ø§ÙÙƒ.', 'Doctor': 'Ø£Ù†Ù‚Ø° Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡.', 'Detective': 'Ø§ÙƒØ´Ù Ø§Ù„Ø®ÙˆÙ†Ø©.', 'Citizen': 'ØµÙˆØª Ø¨Ø­Ø°Ø±.', 'Joker': 'Ø§Ø®Ù„Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚.', 'Authority': 'Ø§Ø­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ø¯Ù„.'}[r]; }
    document.getElementById('chat-input').addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
</script>
</body>
</html>
