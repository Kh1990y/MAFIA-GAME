<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAFIA: M_V1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --accent: #d4af37; --mafia: #ff4444; }
        body { font-family: 'Cairo', sans-serif; background: #050505; color: #fff; margin: 0; overflow-x: hidden; }
        .lobby-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; height: calc(100vh - 120px); }
        @media (max-width: 768px) { .lobby-grid { grid-template-columns: 1fr; height: auto; overflow-y: visible; } }
        .bg-auth { background: url('https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExMHJ3mXprbGZ1a2U2Zm5pZGtwdjVhampseHQ5bmw3NmRndjI3a3IwaiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/JUwa2qSoTwcxv0gFJh/giphy.gif') center/cover no-repeat; }
        .bg-night { background: url('https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3ppcjh1djJtdXhocXd0anBoc251cnFieXlmM3Y3bTh5b2k5aGFmaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rzeWnbH8Uc5Y4/giphy.gif') center/cover no-repeat; }
        .bg-day { background: url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3ppcjh1djJtdXhocXd0anBoc251cnFieXlmM3Y3bTh5b2k5aGFmaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rzeWnbH8Uc5Y4/giphy.gif') center/cover no-repeat; opacity: 0.8; }
        .glass { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 20px; }
        .screen { display: none; min-height: 100dvh; padding: 20px; flex-direction: column; position: relative; z-index: 10; width: 100%; max-width: 1200px; margin: 0 auto; }
        .screen.active { display: flex; }
        .role-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: 2px solid transparent; background: #1a1a1a; position: relative; overflow: hidden; }
        .role-card.active.mafia-card { background: #4a0000; border-color: #ff4444; box-shadow: 0 0 20px rgba(255, 68, 68, 0.4); }
        .role-card.active.doctor-card { background: #003311; border-color: #00ff66; box-shadow: 0 0 20px rgba(0, 255, 102, 0.4); }
        .role-card.active.detective-card { background: #001a33; border-color: #0099ff; box-shadow: 0 0 20px rgba(0, 153, 255, 0.4); }
        .role-card.active.joker-card { background: #1a0033; border-color: #aa00ff; box-shadow: 0 0 20px rgba(170, 0, 255, 0.4); }
        .role-card.active.auth-card { background: #332200; border-color: #d4af37; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .role-card.disabled { opacity: 0.3; filter: grayscale(0.8); }
        .user-identity-bar { background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent); border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding: 10px; text-align: center; font-weight: 900; color: var(--accent); font-size: 12px; }
        .btn-premium { background: linear-gradient(135deg, #d4af37, #aa891f); color: #000; font-weight: 900; border-radius: 12px; transition: 0.3s; }
        .btn-premium:active { transform: scale(0.95); }
        .btn-premium:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #system-alert { position: fixed; inset: 0; z-index: 5000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); }
        .alert-card { width: 90%; max-width: 350px; padding: 40px 20px; text-align: center; border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
        .msg-mafia { border-right: 3px solid var(--mafia); background: rgba(255, 68, 68, 0.05); padding: 5px 10px; border-radius: 5px; }
        .mafia-warning { color: var(--mafia); font-size: 10px; font-weight: 900; animation: pulse 1s infinite; text-align: center; margin-bottom: 5px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-auth">

<div id="system-alert">
    <div class="alert-card glass">
        <div id="alert-icon" class="mb-4 flex justify-center text-accent"></div>
        <h2 id="alert-text" class="text-2xl font-black text-white mb-2 italic"></h2>
        <div class="w-12 h-0.5 bg-accent mx-auto mb-4"></div>
        <p id="alert-sub" class="text-gray-300 font-bold text-sm"></p>
    </div>
</div>

<div class="h-full relative">
    <section id="screen-auth" class="screen active justify-center max-w-md">
        <div class="glass p-8 text-center">
            <h1 class="text-3xl font-black mb-8 tracking-widest text-accent italic">Mafia Game</h1>
            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none">
                <input type="text" id="room-id" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-center text-white outline-none">
                <div class="grid grid-cols-2 gap-3 pt-4">
                    <button id="btn-join" onclick="handleJoin()" class="bg-white/5 border border-white/10 p-4 rounded-xl font-bold disabled:opacity-50">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                    <button id="btn-create" onclick="handleCreate()" class="btn-premium p-4">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-lobby" class="screen">
        <div class="flex justify-between items-center mb-8 bg-black/40 p-4 rounded-2xl border border-white/5">
            <div>
                <p class="text-[9px] text-accent font-black uppercase">Session ID</p>
                <h2 id="display-room-id" class="text-2xl font-black tracking-widest">----</h2>
            </div>
            <div id="player-count" class="bg-accent text-black px-4 py-1 rounded-full text-[10px] font-black">0 PLAYERS</div>
        </div>

        <div class="lobby-grid">
            <div class="flex flex-col">
                <h3 class="text-accent text-xs font-black mb-4 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                <div id="lobby-list" class="space-y-2 overflow-y-auto pr-2"></div>
            </div>

            <div class="flex flex-col">
                <h3 class="text-accent text-xs font-black mb-4 flex items-center gap-2"><i data-lucide="shield" class="w-4 h-4"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
                <div id="role-selection-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6"></div>
                <div id="host-settings" class="hidden glass p-4 mb-4">
                    <button id="start-btn" onclick="startGame()" class="btn-premium w-full py-4 font-black uppercase">Start Operation</button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-role" class="screen justify-center items-center">
        <div class="alert-card glass !opacity-100">
            <i data-lucide="shield-check" class="mx-auto mb-4 text-accent w-12 h-12"></i>
            <h2 id="role-title" class="text-4xl font-black mb-2 uppercase text-white">---</h2>
            <p id="role-desc" class="text-accent text-xs font-bold px-4"></p>
        </div>
    </section>

    <section id="screen-game" class="screen !p-0 max-w-full">
        <div id="player-identity-header" class="user-identity-bar uppercase italic">--</div>
        <div class="p-4 glass !rounded-none !border-0 !border-b border-white/10 flex justify-between items-center">
            <div><h3 id="phase-title" class="font-black text-sm">---</h3><p id="turn-indicator" class="text-[8px] text-accent font-black"></p></div>
            <div id="role-badge" class="px-3 py-1 bg-accent text-black rounded text-[8px] font-black uppercase">--</div>
        </div>
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
        <div class="p-4 glass !rounded-none bg-black/90">
            <div id="mafia-agreement-status" class="mafia-warning hidden">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¶Ø­ÙŠØ© ÙˆØ§Ø­Ø¯Ø©.. ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚!</div>
            <div id="action-grid" class="grid grid-cols-2 gap-2 mb-3"></div>
            <div class="flex gap-2 bg-white/5 p-2 rounded-xl">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-transparent px-2 outline-none text-white text-xs">
                <button id="send-btn" onclick="sendMessage()" class="bg-accent text-black w-10 h-10 rounded-lg flex items-center justify-center"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
    </section>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCgc3oYJOrdOV9Y22x7MzBUEJSGGXsfXUU",
        authDomain: "mafia-game-7dc88.firebaseapp.com",
        databaseURL: "https://mafia-game-7dc88-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "mafia-game-7dc88",
        storageBucket: "mafia-game-7dc88.firebasestorage.app",
        messagingSenderId: "776724825938",
        appId: "1:776724825938:web:afab585356cb94f9a15c8b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let local = { 
        id: '', name: '', role: '', isAlive: true, isHost: false, 
        room: '', phase: '', actionTaken: false, investigated: [], 
        usedHealList: [], authPowerUsed: false, lastProcessedPhase: '',
        selectedRoles: ['Doctor', 'Detective', 'Joker', 'Authority'],
        mafiaCount: 1
    };
    let processedMessages = new Set();

    const ROLE_CONFIG = {
        'Mafia': { name: 'Ø§Ù„Ù…Ø§ÙÙŠØ§', icon: 'skull', class: 'mafia-card', desc: 'Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¶Ø§Ø±Ø¨Ø©ØŒ ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¨Ø­Ø°Ø±.' },
        'Doctor': { name: 'Ø§Ù„Ø·Ø¨ÙŠØ¨', icon: 'heart-pulse', class: 'doctor-card', desc: 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆØª Ø§Ù„Ù„Ø­Ø¸ÙŠ.' },
        'Detective': { name: 'Ø§Ù„Ù…Ø­Ù‚Ù‚', icon: 'search', class: 'detective-card', desc: 'ÙƒØ´Ù Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ÙˆÙØ¶Ø­ Ø§Ù„Ù…Ø§ÙÙŠØ§.' },
        'Joker': { name: 'Ø§Ù„Ø¬ÙˆÙƒÙŠØ±', icon: 'dices', class: 'joker-card', desc: 'Ø§Ù„ÙÙˆØ¶Ù‰ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©ØŒ ØªØºÙŠÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯ÙˆØ§Ø±.' },
        'Authority': { name: 'Ø§Ù„Ø³Ù„Ø·Ø©', icon: 'gavel', class: 'auth-card', desc: 'ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª.' }
    };

    function renderRoleSelection(dataSettings) {
        const container = document.getElementById('role-selection-container');
        container.innerHTML = '';
        const mCard = document.createElement('div');
        mCard.className = `role-card active mafia-card p-4 rounded-xl flex flex-col justify-between h-32`;
        mCard.innerHTML = `
            <div class="flex justify-between items-start">
                <i data-lucide="skull" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase">Ø§Ù„Ù…Ø§ÙÙŠØ§</span>
            </div>
            <div class="mt-2">
                <p class="text-[9px] opacity-70 mb-2">${ROLE_CONFIG['Mafia'].desc}</p>
                <div class="flex items-center gap-3 bg-black/40 p-1 rounded-lg w-fit">
                    ${local.isHost ? `
                        <button onclick="changeMafia(-1)" class="w-6 h-6 bg-red-500/20 rounded">-</button>
                        <span id="m-count-val" class="text-xs font-bold">${local.mafiaCount}</span>
                        <button onclick="changeMafia(1)" class="w-6 h-6 bg-red-500/20 rounded">+</button>
                    ` : `<span class="px-2 text-xs">Ø§Ù„Ø¹Ø¯Ø¯: ${dataSettings?.mafiaCount || 1}</span>`}
                </div>
            </div>
        `;
        container.appendChild(mCard);

        ['Doctor', 'Detective', 'Joker', 'Authority'].forEach(roleKey => {
            const conf = ROLE_CONFIG[roleKey];
            const isActive = local.selectedRoles.includes(roleKey);
            const card = document.createElement('div');
            card.className = `role-card ${isActive ? 'active ' + conf.class : 'disabled'} p-4 rounded-xl flex flex-col justify-between h-32`;
            if(local.isHost) card.onclick = () => toggleRole(roleKey);
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <i data-lucide="${conf.icon}" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black uppercase">${conf.name}</span>
                </div>
                <p class="text-[9px] opacity-70">${conf.desc}</p>
                ${isActive ? '<div class="text-[8px] font-bold text-white/50">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø®Ø¯Ù…Ø©</div>' : ''}
            `;
            container.appendChild(card);
        });
        lucide.createIcons();
    }

    function changeMafia(val) {
        event.stopPropagation();
        let newCount = local.mafiaCount + val;
        if(newCount < 1) newCount = 1;
        if(newCount > 4) newCount = 4;
        local.mafiaCount = newCount;
        db.ref(`games/${local.room}/settings`).update({ mafiaCount: newCount });
    }

    function toggleRole(role) {
        if(local.selectedRoles.includes(role)) {
            local.selectedRoles = local.selectedRoles.filter(r => r !== role);
        } else {
            local.selectedRoles.push(role);
        }
        db.ref(`games/${local.room}/settings`).update({ selectedRoles: local.selectedRoles });
    }

    function showSystemCard(title, sub, iconName = "bell") {
    const overlay = document.getElementById('system-alert');
    document.getElementById('alert-text').innerText = title;
    document.getElementById('alert-sub').innerText = sub;
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    document.getElementById('alert-icon').innerHTML = `<i data-lucide="${iconName}" class="w-12 h-12"></i>`;
    
    overlay.style.display = 'flex';
    lucide.createIcons(); // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹

    setTimeout(() => { 
        overlay.style.display = 'none'; 
    }, 5000);
}

    function navigate(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        lucide.createIcons();
    }

    function handleCreate() {
        const name = document.getElementById('user-name').value.trim();
        if(!name) return;
        document.getElementById('btn-create').disabled = true;
        document.getElementById('btn-join').disabled = true;
        local.room = Math.floor(1000 + Math.random() * 9000).toString();
        local.id = 'p_' + Date.now(); local.name = name; local.isHost = true;
        db.ref(`games/${local.room}`).set({ 
            status: 'lobby', host: local.id,
            settings: { selectedRoles: local.selectedRoles, mafiaCount: 1 },
            players: { [local.id]: { name, isAlive: true, role: '' } } 
        }).then(listen);
    }

    function handleJoin() {
        const name = document.getElementById('user-name').value.trim();
        const rId = document.getElementById('room-id').value.trim();
        if(!name || !rId) return;
        document.getElementById('btn-join').disabled = true;
        document.getElementById('btn-create').disabled = true;
        local.room = rId; local.name = name;
        db.ref(`games/${rId}`).once('value', snap => {
            if(!snap.exists()) {
                alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                document.getElementById('btn-join').disabled = false;
                document.getElementById('btn-create').disabled = false;
                return;
            }
            const data = snap.val();
            local.id = Object.keys(data.players).find(k => data.players[k].name === name) || 'p_' + Date.now();
            local.isHost = (data.host === local.id);
            db.ref(`games/${rId}/players/${local.id}`).update({ name, isAlive: true });
            listen();
        });
    }

    function kickPlayer(pid) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ")) {
            db.ref(`games/${local.room}/players/${pid}`).remove();
        }
    }

    function listen() {
        document.getElementById('display-room-id').innerText = local.room;
        db.ref(`games/${local.room}`).on('value', snap => {
            const data = snap.val(); if(!data) return;

            if (data.players && !data.players[local.id]) {
                alert("Ù„Ù‚Ø¯ ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©!");
                location.reload();
                return;
            }

            if(data.status === 'lobby') {
                if(data.settings) {
                    local.selectedRoles = data.settings.selectedRoles || [];
                    local.mafiaCount = data.settings.mafiaCount || 1;
                }
                renderRoleSelection(data.settings);
                const entries = Object.entries(data.players);
                document.getElementById('lobby-list').innerHTML = entries.map(([id, p]) => `
                    <div class="glass p-4 flex justify-between items-center border-white/5">
                        <span class="font-bold flex items-center gap-2 text-sm">
                            <i data-lucide="user" class="w-3 h-3 text-accent"></i> ${p.name}
                            ${data.host === id ? '<span class="text-[8px] bg-accent/20 text-accent px-1 rounded">HOST</span>' : ''}
                        </span>
                        <div class="flex items-center gap-3">
                            ${local.isHost && id !== local.id ? `
                                <button onclick="kickPlayer('${id}')" class="text-red-500 text-[10px] font-bold border border-red-500/20 px-2 py-1 rounded">Ø·Ø±Ø¯</button>
                            ` : ''}
                            <span class="text-[9px] text-white/30 uppercase tracking-tighter">Verified</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('player-count').innerText = entries.length + " PLAYERS";
                if(local.isHost && entries.length >= 4) document.getElementById('host-settings').classList.remove('hidden');
                navigate('screen-lobby');
            }

            if(data.status === 'assigning') {
                const me = data.players[local.id];
                if(me?.role && local.role !== me.role) {
                    local.role = me.role;
                    updateUIForRole(local.role);
                    navigate('screen-role');
                    setTimeout(() => navigate('screen-game'), 6000);
                }
            }

            if(data.status === 'night' || data.status === 'day') {
    const myCurrentData = data.players[local.id];
    
    // Ø¥Ø°Ø§ ØªØºÙŠØ± Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆÙ‡Ùˆ Ø­ÙŠØŒ Ø£Ø¸Ù‡Ø± Ù„Ù‡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹
   if (myCurrentData && myCurrentData.role !== local.role && myCurrentData.isAlive) {
    local.role = myCurrentData.role;
    local.actionTaken = false; 
    updateUIForRole(local.role); 
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ù„Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    navigate('screen-role');      
    
    // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ Ø±Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    setTimeout(() => {
        lucide.createIcons();
    }, 100);

    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Øª Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
    setTimeout(() => {
        // Ù†ØªØ­Ù‚Ù‚ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø²Ø§Ù„ ÙÙŠ Ø­Ø§Ù„Ø© ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø¹ÙˆØ¯Ø© (Ù„ÙŠØ³Øª Ù†Ù‡Ø§Ø±Ø§Ù‹ Ù…ÙØ§Ø¬Ø¦Ø§Ù‹ Ù…Ø«Ù„Ø§Ù‹)
        if(document.getElementById('screen-role').classList.contains('active')) {
            navigate('screen-game');
        }
    }, 5000);
}
                if(local.phase !== data.status) {
                    const oldPhase = local.phase;
                    local.phase = data.status; 
					local.actionTaken = false;
                    document.body.className = (data.status === 'night' ? 'bg-night' : 'bg-day');
                    
                    if(oldPhase !== '' && local.isHost) {
        if(data.status === 'night') broadcastEvent("Ø­Ù„ Ø§Ù„Ù„ÙŠÙ„", "Ø£ØºÙ…Ø¶ÙˆØ§ Ø£Ø¹ÙŠÙ†ÙƒÙ….. Ø¨Ø¯Ø£Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ©.", "moon");
        else broadcastEvent("Ø·Ù„Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±", "Ø§Ø³ØªÙŠÙ‚Ø¸ÙˆØ§.. Ø¨Ø¯Ø£Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ù†Ù‚Ø§Ø´.", "sun");
    }
}
                local.isAlive = data.players[local.id].isAlive;
                renderGame(data);
                if(local.isHost) checkLoop(data);
                checkWin(data);
            }

            if(data.status === 'result') {
                showSystemCard("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©", "Ø§Ù†ØªØµØ§Ø± " + data.winner, "trophy");
                setTimeout(() => location.reload(), 8000);
            }
            if(data.messages) renderMsgs(data.messages);
        });
    }

    function updateUIForRole(role) {
        const rName = translateRole(role);
        document.getElementById('role-title').innerText = rName;
        document.getElementById('player-identity-header').innerText = local.name + " | " + rName;
        document.getElementById('role-badge').innerText = rName;
        document.getElementById('role-desc').innerText = getRoleDesc(role);
    }

    function renderGame(data) {
        const grid = document.getElementById('action-grid');
        const mWarn = document.getElementById('mafia-agreement-status');
        grid.innerHTML = '';
        mWarn.classList.add('hidden');
        
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        if(data.status === 'night' && local.role !== 'Mafia') {
            chatInput.disabled = true; chatInput.placeholder = "Ø§Ù„Ø´Ø§Øª Ù…ØºÙ„Ù‚ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„..";
            sendBtn.disabled = true;
        } else {
            chatInput.disabled = false; chatInput.placeholder = "Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...";
            sendBtn.disabled = false;
        }

        if(!local.isAlive) return;
        if(local.actionTaken) {
            document.getElementById('turn-indicator').innerText = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø±Ø§Ø±Ùƒ Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©";
            return;
        }

        const aliveIds = Object.keys(data.players).filter(id => data.players[id].isAlive);

        if(data.status === 'night') {
            document.getElementById('phase-title').innerText = "Ù„ÙŠÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª";
            
            if(local.role === 'Mafia' && data.nightVotes) {
                const targets = Object.values(data.nightVotes);
                const uniqueTargets = [...new Set(targets)];
                const mAlive = Object.values(data.players).filter(p => p.isAlive && p.role === 'Mafia').length;
                if(uniqueTargets.length > 1 && targets.length >= mAlive) mWarn.classList.remove('hidden');
            }

            if(local.role === 'Joker') grid.innerHTML += `<button onclick="jokerPower()" class="col-span-2 p-3 bg-purple-900 border border-purple-500 rounded-xl text-[10px] font-black animate-pulse">ğŸƒ Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</button>`;
            aliveIds.forEach(id => {
                const p = data.players[id];
                if(local.role === 'Mafia' && p.role !== 'Mafia') grid.innerHTML += `<button onclick="db.ref('games/${local.room}/nightVotes/${local.id}').set('${id}')" class="bg-red-900/40 border border-red-500 p-3 text-[10px] rounded-xl">Ø§ØºØªÙŠØ§Ù„ ${p.name}</button>`;
                else if(local.role === 'Doctor' && !local.usedHealList.includes(id)) grid.innerHTML += `<button onclick="doctorAction('${id}')" class="bg-emerald-900/40 border border-emerald-500 p-3 text-[10px] rounded-xl">Ø­Ù…Ø§ÙŠØ© ${p.name}</button>`;
                else if(local.role === 'Detective' && id !== local.id && !local.investigated.includes(id)) grid.innerHTML += `<button onclick="investigateAction('${id}', '${p.name}', '${p.role}')" class="bg-blue-900/40 border border-blue-500 p-3 text-[10px] rounded-xl">ÙƒØ´Ù ${p.name}</button>`;
            });
        } else {
            document.getElementById('phase-title').innerText = "Ù†Ù‡Ø§Ø± Ø§Ù„Ù†Ù‚Ø§Ø´";
            if(local.role === 'Authority' && !local.authPowerUsed) {
                grid.innerHTML += `<button onclick="handleDayVote('${local.id}')" class="col-span-2 p-3 bg-amber-900 border border-amber-500 rounded-xl text-[10px]">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù…Ø·Ù„Ù‚</button>`;
            }
            aliveIds.forEach(id => {
                grid.innerHTML += `<button onclick="handleDayVote('${id}')" class="bg-white/5 border border-white/10 p-3 text-[10px] rounded-xl">${data.players[id].name}</button>`;
            });
            grid.innerHTML += `<button onclick="handleDayVote('skip')" class="col-span-2 border border-accent/30 p-3 text-[10px] rounded-xl text-accent">ØªØ®Ø·ÙŠ Ø§Ù„ØªØµÙˆÙŠØª</button>`;
        }
    }

    function handleDayVote(tid) {
        local.actionTaken = true;
        db.ref(`games/${local.room}/dayVotes/${local.id}`).set({target: tid, isSuperVote: (local.role === 'Authority' && tid === local.id)});
    }

    function jokerPower() { 
    local.actionTaken = true; 
    // Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù‡ÙˆØ³Øª Ø¨Ø£Ù† Ø§Ù„Ø¬ÙˆÙƒÙŠØ± Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø¯Ø±ØªÙ‡
    db.ref(`games/${local.room}/nightActions/joker`).set(true); 
}

    function doctorAction(tid) { local.actionTaken = true; local.usedHealList.push(tid); db.ref(`games/${local.room}/nightActions/heal`).set(tid); }
    
    // ØªØ¹Ø¯ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ù…Ø­Ù‚Ù‚: ÙŠØ¸Ù‡Ø± Ù„Ù‡ ÙÙ‚Ø· ÙƒØ¨Ø·Ø§Ù‚Ø© ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ ÙƒÙ€ broadcastEvent Ø¹Ø§Ù…
    function investigateAction(id, name, role) { 
        local.actionTaken = true; 
        local.investigated.push(id); 
        const res = (role === 'Mafia') ? "Ù…Ø§ÙÙŠØ§ ğŸ’€" : "ØµØ§Ù„Ø­ âœ…"; 
        showSystemCard(`Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ø±ÙŠØ©`, `${name} Ù‡Ùˆ ${res}`, "search"); 
        db.ref(`games/${local.room}/nightActions/detective`).set(true); 
    }

    function startGame() {
    db.ref(`games/${local.room}`).once('value', s => {
        const data = s.val();
        const ids = Object.keys(data.players);
        let roles = [];
        for(let i=0; i< (data.settings.mafiaCount || 1); i++) roles.push('Mafia');
        (data.settings.selectedRoles || []).forEach(r => roles.push(r));
        while(roles.length < ids.length) roles.push('Citizen');
        roles = roles.slice(0, ids.length).sort(() => Math.random() - 0.5);

        // 1. Ø£ÙˆÙ„Ø§Ù‹: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† "Ø­Ù„ Ø§Ù„Ù„ÙŠÙ„" Ù„Ù„Ø¬Ù…ÙŠØ¹
        broadcastEvent("Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "Ø£ØºÙ…Ø¶ÙˆØ§ Ø£Ø¹ÙŠÙ†ÙƒÙ….. Ø¨Ø¯Ø£ ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠÙ„.", "moon");

        // 2. Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (ØªØ¸Ù‡Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
        setTimeout(() => {
            const up = { status: 'assigning' };
            ids.forEach((id, i) => up[`players/${id}/role`] = roles[i]);
            db.ref(`games/${local.room}`).update(up);
            
            // 3. Ø«Ø§Ù„Ø«Ø§Ù‹: Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù Ø£Ø®Ø±Ù‰ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø¯ÙˆØ§Ø±ØŒ ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙØ¹Ù„ÙŠØ§Ù‹
            setTimeout(() => {
                db.ref(`games/${local.room}`).update({ status: 'night', phaseId: Date.now() });
            }, 5000); 

        }, 5000); 
    });
}

    function checkLoop(data) {
    if (!local.isHost || data.phaseId === local.lastProcessedPhase) return;
    const alivePlayers = Object.entries(data.players).filter(e => e[1].isAlive);
    const aliveIds = alivePlayers.map(e => e[0]);

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬ÙˆÙƒÙŠØ± (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ)
    if (data.status === 'night' && data.nightActions?.joker === true) {
        const otherAlivePlayers = alivePlayers.filter(e => e[1].role !== 'Joker');
        const otherAliveIds = otherAlivePlayers.map(e => e[0]);
        let currentAliveRoles = otherAlivePlayers.map(e => e[1].role);
        currentAliveRoles.sort(() => Math.random() - 0.5);
        let up = { "nightActions/joker": "done", phaseId: Date.now() };
        otherAliveIds.forEach((id, i) => up[`players/${id}/role`] = currentAliveRoles[i]);
        db.ref(`games/${local.room}`).update(up);
        broadcastEvent("Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¬ÙˆÙƒÙŠØ±", "ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø®Ù„Ø· Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø­ÙŠØ§Ø¡!", "dices");
        return;
    }

    if(data.status === 'night') {
        const votes = data.nightVotes ? Object.values(data.nightVotes) : [];
        const mAlive = alivePlayers.filter(p => p[1].role === 'Mafia').length;
        
        // --- Ø§Ù„Ø­Ù„ Ù‡Ù†Ø§: ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£Ù†Ù‡Øª Ù…Ù‡Ø§Ù…Ù‡Ø§ ---
        const isDocAlive = alivePlayers.some(p => p[1].role === 'Doctor');
        const isDetAlive = alivePlayers.some(p => p[1].role === 'Detective');

        const mafiaDone = votes.length >= mAlive; 
        const docDone = !isDocAlive || (data.nightActions && data.nightActions.heal);
        const detDone = !isDetAlive || (data.nightActions && data.nightActions.detective);

        // Ù„Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ù„ÙŠÙ„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªØ­Ù‚Ù‚ (mafiaDone Ùˆ docDone Ùˆ detDone) Ù…Ø¹Ø§Ù‹
        if(mafiaDone && docDone && detDone) {
            const uniqueTargets = [...new Set(votes)];
            if(uniqueTargets.length === 1) {
                local.lastProcessedPhase = data.phaseId;
                const target = uniqueTargets[0];
                
                let resultTitle = "Ù„ÙŠÙ„Ø© Ù‡Ø§Ø¯Ø¦Ø©";
                let resultSub = "Ù„Ù… ÙŠØ­Ø¯Ø« Ø´ÙŠØ¡ Ù…Ø±ÙŠØ¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.";
                let resultIcon = "moon";

                if(target !== 'skip' && target !== data.nightActions?.heal) {
                    db.ref(`games/${local.room}/players/${target}`).update({ isAlive: false });
                    resultTitle = "Ø¬Ø±ÙŠÙ…Ø© Ù‚ØªÙ„";
                    resultSub = `Ø¹Ø«Ø±Øª Ø§Ù„Ø´Ø±Ø·Ø© Ø¹Ù„Ù‰ Ø¬Ø«Ø© ${data.players[target].name}.`;
                    resultIcon = "skull";
                } else if(target !== 'skip' && target === data.nightActions?.heal) {
                    resultTitle = "Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ´Ù„Øª";
                    resultSub = "Ø­Ø§ÙˆÙ„Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ø§Ù„Ù‚ØªÙ„ØŒ Ù„ÙƒÙ† Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯!";
                    resultIcon = "heart-pulse";
                }

                broadcastEvent(resultTitle, resultSub, resultIcon);

                setTimeout(() => {
                    db.ref(`games/${local.room}`).update({ 
                        status: 'day', 
                        phaseId: Date.now(), 
                        nightVotes: null, 
                        nightActions: null 
                    });
                }, 2000);
            }
        }
    } else if(data.status === 'day') {
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø± ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
        const vtsRaw = data.dayVotes ? Object.entries(data.dayVotes) : [];
        if(vtsRaw.length >= aliveIds.length) {
            local.lastProcessedPhase = data.phaseId;
            const voted = vtsRaw[0][1].target;
            if(voted !== 'skip') {
                db.ref(`games/${local.room}/players/${voted}`).update({ isAlive: false });
                broadcastEvent("Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", `ØªÙ… Ø¥Ø¹Ø¯Ø§Ù… ${data.players[voted].name}.`, "gavel");
            } else {
                broadcastEvent("ØªØµÙˆÙŠØª Ù…Ø¹Ù„Ù‚", "Ù„Ù… ØªØªÙÙ‚ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ù… Ø£Ø­Ø¯.", "users");
            }
            setTimeout(() => {
                db.ref(`games/${local.room}`).update({ status: 'night', phaseId: Date.now(), dayVotes: null });
            }, 2000);
        }
    }
}

    function checkWin(data) {
        if (!local.isHost) return;
        const ps = Object.values(data.players);
        const m = ps.filter(x => x.isAlive && x.role === 'Mafia').length;
        const c = ps.filter(x => x.isAlive && x.role !== 'Mafia').length;
        if(m === 0 && data.status !== 'lobby') db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†' });
        else if(m >= c && data.status !== 'assigning' && data.status !== 'lobby') db.ref(`games/${local.room}`).update({ status: 'result', winner: 'Ø§Ù„Ù…Ø§ÙÙŠØ§' });
    }

    function broadcastEvent(title, sub, icon) {
    db.ref(`games/${local.room}/messages`).push({ 
        text: `${title}: ${sub}`, 
        type: 'system', 
        cardTitle: title, 
        cardSub: sub, 
        cardIcon: icon, 
        time: firebase.database.ServerValue.TIMESTAMP // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø¯Ù‚
    });
}

    function sendMessage() {
        const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
        let type = 'player';
        if(local.phase === 'night') type = 'mafia'; 
        if(!local.isAlive) type = 'ghost';
        db.ref(`games/${local.room}/messages`).push({ sender: local.name, text: txt, type, senderId: local.id, time: Date.now() });
        inp.value = '';
    }

    function renderMsgs(msgs) {
    const box = document.getElementById('chat-box'); 
    box.innerHTML = '';
    Object.keys(msgs).forEach(msgId => {
        const m = msgs[msgId];
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù… ÙˆÙ„Ù… ØªØ¹Ø§Ù„Ø¬ Ù…Ù† Ù‚Ø¨Ù„
        if(m.type === 'system' && !processedMessages.has(msgId)) {
            showSystemCard(m.cardTitle || "ØªÙ†Ø¨ÙŠÙ‡", m.cardSub || m.text, m.cardIcon || "bell");
            processedMessages.add(msgId);
        }

        // Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ù…Ø§ÙÙŠØ§ ÙˆØ§Ù„Ù‡Ù…Ø³ ÙˆØ§Ù„Ø£Ø´Ø¨Ø§Ø­)
        if(m.type === 'mafia' && local.role !== 'Mafia') return;
        if(m.type === 'ghost' && local.isAlive) return;
        
        const div = document.createElement('div');
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…ØŒ Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙƒÙ†Øµ ØµØºÙŠØ± Ø£Ø³ÙÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„ØªÙˆØ«ÙŠÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø´Ø§Øª
        if(m.type === 'system') { 
            div.className = "text-center text-[9px] text-accent/60 my-2 italic"; 
            div.innerText = "ğŸ“¢ " + (m.cardSub || m.text); 
        } else { 
            div.className = `msg ${m.senderId === local.id ? 'msg-me' : 'msg-player'} ${m.type === 'mafia' ? 'msg-mafia' : ''}`; 
            div.innerHTML = `<span class="text-[8px] opacity-50 block">${m.sender}${m.type === 'mafia' ? ' (Ù‡Ù…Ø³ Ø§Ù„Ù…Ø§ÙÙŠØ§)' : ''}</span>${m.text}`; 
        }
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}

    function translateRole(r) { return {'Mafia': 'Ø§Ù„Ù…Ø§ÙÙŠØ§', 'Doctor': 'Ø§Ù„Ø·Ø¨ÙŠØ¨', 'Detective': 'Ø§Ù„Ù…Ø­Ù‚Ù‚', 'Citizen': 'Ù…ÙˆØ§Ø·Ù†', 'Joker': 'Ø§Ù„Ø¬ÙˆÙƒÙŠØ±', 'Authority': 'Ø§Ù„Ø³Ù„Ø·Ø©'}[r] || r; }
    function getRoleDesc(r) { return {'Mafia': 'ØµÙÙŠ Ø£Ù‡Ø¯Ø§ÙÙƒ.', 'Doctor': 'Ø£Ù†Ù‚Ø° Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡.', 'Detective': 'Ø§ÙƒØ´Ù Ø§Ù„Ø®ÙˆÙ†Ø©.', 'Citizen': 'ØµÙˆØª Ø¨Ø­Ø°Ø±.', 'Joker': 'Ø§Ø®Ù„Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚.', 'Authority': 'Ø§Ø­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ø¯Ù„.'}[r]; }
    document.getElementById('chat-input').addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
</script>
</body>
</html>
