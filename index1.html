<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لعبة مافيا الالكترونية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { 
            --neon-blue: #00f3ff; 
            --neon-purple: #bc13fe; 
            --bg-dark: #020205; 
            --mafia-red: #ff003c; 
            --neom-gradient: linear-gradient(135deg, #00f3ff 0%, #bc13fe 100%);
            --glass: rgba(10, 10, 20, 0.8);
        }

        body, html { 
            margin: 0; padding: 0; 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background: var(--bg-dark); 
            color: #fff; height: 100dvh; 
            overflow: hidden; touch-action: manipulation; 
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        .cyber-bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0a0a20 0%, #020205 100%);
        }

        .grid-bg { 
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(188, 19, 254, 0.1) 1px, transparent 1px); 
            background-size: 50px 50px; 
            transform: perspective(800px) rotateX(60deg);
            animation: moveGrid 10s linear infinite; 
        }

        @keyframes moveGrid { 
            from { transform: perspective(800px) rotateX(60deg) translateY(0); } 
            to { transform: perspective(800px) rotateX(60deg) translateY(50px); } 
        }

        .nebula {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(188, 19, 254, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(0, 243, 255, 0.15) 0%, transparent 50%);
            filter: blur(80px); animation: drift 20s ease-in-out infinite alternate;
        }

        @keyframes drift { from { transform: scale(1); } to { transform: scale(1.2); } }

        .main-wrapper {
            width: 100%; max-width: 450px; height: 100dvh; margin: 0 auto;
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,1); border-left: 1px solid rgba(0, 243, 255, 0.1); border-right: 1px solid rgba(0, 243, 255, 0.1);
        }

        .screen { 
            display: none; flex: 1; flex-direction: column; padding: 20px; 
            overflow: hidden; justify-content: center;
        }
        .screen.active { display: flex; animation: screenIn 0.5s cubic-bezier(0.1, 0.7, 0.1, 1) forwards; }

        @keyframes screenIn { from { opacity: 0; filter: blur(10px); } to { opacity: 1; filter: blur(0); } }

        .glass-panel {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(15px); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 25px;
        }

        .input-cyber {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(0, 243, 255, 0.2);
            padding: 15px; border-radius: 12px; width: 100%; outline: none;
            color: #fff; font-weight: bold; text-align: center; transition: 0.3s;
        }
        .input-cyber:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        .neon-btn { 
            background: var(--neom-gradient); color: #000; font-weight: 900; 
            padding: 16px; border-radius: 12px; transition: 0.3s; 
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); text-transform: uppercase;
        }
        .neon-btn:active { transform: scale(0.95); }

        .chat-container { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; 
            flex-direction: column; gap: 10px; scroll-behavior: smooth;
        }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; }
        .msg-player { background: rgba(0, 243, 255, 0.08); border: 1px solid rgba(0, 243, 255, 0.2); align-self: flex-start; }
        .msg-mafia { background: rgba(255, 0, 60, 0.1); border: 1px solid rgba(255, 0, 60, 0.3); align-self: flex-end; }
        .msg-dead { background: rgba(68, 68, 68, 0.2); color: #888; align-self: center; font-style: italic; border: 1px dashed #444; }
        .msg-system { background: rgba(255,255,255,0.05); width: 100%; text-align: center; font-size: 11px; color: var(--neon-blue); }

        .action-hub {
            padding: 20px; background: rgba(0,0,0,0.8); 
            border-top: 2px solid rgba(188, 19, 254, 0.3);
            border-radius: 30px 30px 0 0;
        }

        #notify-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 85%; }
        .toast { 
            background: var(--neom-gradient); color: #000; padding: 12px; 
            border-radius: 10px; font-weight: 900; font-size: 12px; text-align: center;
            margin-bottom: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .role-reveal-anim { animation: pulseGlow 2s infinite alternate; }
        @keyframes pulseGlow { from { box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); } to { box-shadow: 0 0 40px rgba(0, 243, 255, 0.5); } }

    </style>
</head>
<body dir="rtl">

<div class="cyber-bg-container">
    <div class="nebula"></div>
    <div class="grid-bg"></div>
</div>

<div id="notify-box"></div>

<div class="main-wrapper">
    <header class="p-4 flex justify-between items-center border-b border-white/5 bg-black/40 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div id="status-glow" class="w-2 h-2 rounded-full bg-red-600 shadow-[0_0_8px_red]"></div>
            <div>
                <h1 class="orbitron text-sm font-black tracking-widest leading-none">TRUE <span class="text-cyan-400">MAFIA</span></h1>
                <p id="room-status" class="text-[8px] text-gray-500 font-bold uppercase mt-1">Status: Initializing...</p>
            </div>
        </div>
        <div id="role-hud" class="hidden text-[10px] bg-white/5 px-3 py-1 rounded-full border border-white/10 font-black">
            ID: <span id="hud-role-name" class="text-cyan-400">---</span>
        </div>
    </header>

    <main class="flex-1 relative flex flex-col overflow-hidden">
        
        <section id="screen-auth" class="screen active">
            <div class="glass-panel text-center">
                <div class="mb-6"><i data-lucide="aperture" class="w-16 h-16 text-cyan-400 mx-auto animate-spin-slow"></i></div>
                <h2 class="orbitron text-2xl font-black mb-6 bg-clip-text text-transparent bg-gradient-to-l from-cyan-400 to-purple-500">اهلا بك في لعبة "مافيا"</h2>
                <div class="space-y-4">
                    <input type="text" id="user-name" placeholder="اسمك" class="input-cyber">
                    <input type="text" id="room-id" placeholder="كود المجموعة" class="input-cyber">
                    <div class="grid grid-cols-2 gap-3 pt-4">
                        <button onclick="handleJoin()" class="p-4 rounded-xl border border-cyan-500/30 font-black text-xs">مزامنة</button>
                        <button onclick="handleCreate()" class="neon-btn text-xs">توليد مجموعة</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="screen-lobby" class="screen">
            <div class="flex-1 flex flex-col">
                <div class="glass-panel mb-4 py-4 flex justify-between items-center">
                    <h2 class="orbitron text-sm font-bold">مجموعة: <span id="display-room-id" class="text-cyan-400">----</span></h2>
                    <span id="player-count" class="text-[10px] font-black opacity-60">0 عدد الاشخاص</span>
                </div>
                <div id="lobby-list" class="flex-1 space-y-2 overflow-y-auto pr-2"></div>
                <button id="start-btn" onclick="startGame()" class="neon-btn w-full mt-4 text-sm hidden">بدء اللعبة</button>
            </div>
        </section>

        <section id="screen-role" class="screen items-center">
            <div class="role-reveal-anim glass-panel w-full text-center py-12">
                <div class="w-20 h-20 border-2 border-cyan-500/50 rounded-2xl flex items-center justify-center mx-auto mb-6 bg-cyan-500/10">
                    <i id="role-main-icon" data-lucide="fingerprint" class="w-10 h-10 text-cyan-400"></i>
                </div>
                <h3 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.3em] mb-2">Identity Verified</h3>
                <h2 id="role-title" class="text-5xl font-black mb-6 orbitron tracking-tighter">---</h2>
                <p id="role-desc" class="text-xs text-gray-400 leading-relaxed max-w-[200px] mx-auto"></p>
            </div>
        </section>

        <section id="screen-game" class="screen !p-0">
            <div class="bg-black/60 backdrop-blur-md p-3 px-6 flex justify-between items-center border-b border-white/5">
                <div class="text-[10px] font-black text-cyan-400 orbitron uppercase" id="phase-title">Syncing</div>
                <div id="turn-indicator" class="text-[9px] bg-cyan-500/20 text-cyan-400 px-3 py-1 rounded-md font-black border border-cyan-500/30">WAIT</div>
            </div>
            
            <div id="chat-box" class="chat-container"></div>
            
            <div class="action-hub">
                <div id="action-grid" class="grid grid-cols-2 gap-2 mb-4"></div>
                <div class="flex gap-2 bg-white/5 p-2 rounded-2xl border border-white/10">
                    <input type="text" id="chat-input" placeholder="رسالة مشفرة..." class="flex-1 bg-transparent px-3 text-sm outline-none">
                    <button onclick="sendMessage()" class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                        <i data-lucide="send" class="w-4 h-4 text-black"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="screen-result" class="screen">
            <div class="glass-panel text-center" id="result-card">
                <div id="winner-icon-box" class="mb-6">
                    <i id="winner-icon" data-lucide="trophy" class="w-20 h-20 mx-auto"></i>
                </div>
                <h2 id="winner-name" class="orbitron text-3xl font-black mb-2 tracking-tighter">END</h2>
                <p id="winner-detail" class="text-sm text-gray-400 mb-8 font-bold"></p>
                <button onclick="location.reload()" class="neon-btn w-full text-xs">إعادة تهيئة النظام</button>
            </div>
        </section>

    </main>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCgc3oYJOrdOV9Y22x7MzBUEJSGGXsfXUU",
        authDomain: "mafia-game-7dc88.firebaseapp.com",
        databaseURL: "https://mafia-game-7dc88-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "mafia-game-7dc88",
        storageBucket: "mafia-game-7dc88.firebasestorage.app",
        messagingSenderId: "776724825938",
        appId: "1:776724825938:web:afab585356cb94f9a15c8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let local = { id: '', name: '', role: '', isAlive: true, isHost: false, room: '', phase: '', actionTaken: false };
    const roleMeta = {
        'Mafia': { icon: 'skull', color: '#ff003c', desc: 'تسلل وتخلص من العملاء دون ترك أثر رقمي.' },
        'Doctor': { icon: 'shield-plus', color: '#00ff88', desc: 'قم بحماية البروتوكولات الحيوية لزملائك.' },
        'Detective': { icon: 'scan-eye', color: '#00f3ff', desc: 'دوره يكشف دور واحد واحد من اللعبة' },
        'Citizen': { icon: 'user', color: '#ffffff', desc: 'راقب النشاطات المشبوهة وصوت ضد الخونة.' }
    };

    function notify(msg) {
        const box = document.getElementById('notify-box');
        const toast = document.createElement('div');
        toast.className = 'toast'; toast.innerText = msg;
        box.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
    }

    function navigate(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        lucide.createIcons();
    }

    function handleCreate() {
        const name = document.getElementById('user-name').value.trim();
        if(!name) return notify("أدخل اسمك أولاً");
        local.room = Math.floor(1000 + Math.random() * 9000).toString();
        local.id = 'p_' + Date.now(); local.name = name; local.isHost = true;
        db.ref('games/' + local.room).set({
            status: 'lobby', host: local.id,
            players: { [local.id]: { name: name, isAlive: true, role: '' } }
        }).then(() => { listen(); notify("تم إنشاء القطاع"); });
    }

    function handleJoin() {
        const name = document.getElementById('user-name').value.trim();
        const rId = document.getElementById('room-id').value.trim();
        if(!name || !rId) return notify("أكمل البيانات");
        local.room = rId; local.name = name;
        db.ref(`games/${rId}`).once('value', snap => {
            if(!snap.exists()) return notify("القطاع غير موجود");
            const data = snap.val();
            let existingId = Object.keys(data.players).find(k => data.players[k].name === name);
            local.id = existingId || 'p_' + Date.now();
            if(!existingId) db.ref(`games/${rId}/players/${local.id}`).set({ name: name, isAlive: true, role: '' });
            listen();
        });
    }

    function listen() {
        document.getElementById('room-status').innerText = "Sector: " + local.room;
        document.getElementById('display-room-id').innerText = local.room;
        db.ref('games/' + local.room).on('value', snap => {
            const data = snap.val(); if(!data) return;

            if(data.status === 'lobby') {
                const players = Object.values(data.players);
                document.getElementById('lobby-list').innerHTML = players.map(p => `
                    <div class="glass-panel !p-4 !rounded-xl flex justify-between items-center border border-white/5">
                        <span class="font-bold text-sm">${p.name}</span>
                        <div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></span><span class="text-[9px] font-black opacity-50">SYNCED</span></div>
                    </div>`).join('');
                document.getElementById('player-count').innerText = players.length + " عدد الاشخاص";
                if(local.isHost && players.length >= 4) document.getElementById('start-btn').classList.remove('hidden');
                navigate('screen-lobby');
            }

            if(data.status === 'assigning') {
                const me = data.players[local.id];
                if(me && me.role) {
                    local.role = me.role;
                    document.getElementById('role-hud').classList.remove('hidden');
                    document.getElementById('hud-role-name').innerText = translateRole(local.role);
                    document.getElementById('role-title').innerText = translateRole(local.role);
                    document.getElementById('role-title').style.color = roleMeta[local.role].color;
                    document.getElementById('role-desc').innerText = roleMeta[local.role].desc;
                    document.getElementById('role-main-icon').setAttribute('data-lucide', roleMeta[local.role].icon);
                    navigate('screen-role');
                    setTimeout(() => navigate('screen-game'), 5000);
                }
            }

            if(data.status === 'night' || data.status === 'day') {
                const me = data.players[local.id];
                if(me) { 
                    local.role = me.role; local.isAlive = me.isAlive;
                    document.getElementById('hud-role-name').innerText = translateRole(local.role) + (local.isAlive ? "" : " (تصفية)");
                    if(local.phase !== data.status) { local.phase = data.status; local.actionTaken = false; }
                }
                renderGame(data);
                if(local.isHost) checkLoop(data);
                checkWin(data);
            }

            if(data.status === 'result') showResult(data.winner);
            if(data.messages) renderMsgs(data.messages);
        });
    }

    function translateRole(r) {
        const trans = {'Mafia': 'مافيا', 'Doctor': 'طبيب', 'Detective': 'محقق', 'Citizen': 'مواطن'};
        return trans[r] || r;
    }

    function renderGame(data) {
        navigate('screen-game');
        const grid = document.getElementById('action-grid');
        const indicator = document.getElementById('turn-indicator');
        const phaseTitle = document.getElementById('phase-title');
        grid.innerHTML = '';
        phaseTitle.innerText = data.status === 'night' ? "مرحلة الليل" : "مرحلة النهار";

        if(data.status === 'night') {
            if(local.actionTaken) { indicator.innerText = "LOCKED"; return; }
            indicator.innerText = "اتخذ قرارك";
            if(local.role === 'Mafia' && local.isAlive) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive && data.players[id].role !== 'Mafia') 
                        grid.innerHTML += `<button onclick="doAction('nightVotes', '${id}')" class="p-3 border border-red-500/30 bg-red-500/5 rounded-xl text-[10px] font-black text-red-500">تصفية ${data.players[id].name}</button>`;
                });
            } else if(local.role === 'Doctor' && local.isAlive && !data.nightActions?.heal) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive) 
                        grid.innerHTML += `<button onclick="doAction('nightActions/heal', '${id}')" class="p-3 border border-green-500/30 bg-green-500/5 rounded-xl text-[10px] font-black text-green-500">حماية ${data.players[id].name}</button>`;
                });
            } else if(local.role === 'Detective' && local.isAlive) {
                Object.keys(data.players).forEach(id => {
                    if(id !== local.id && data.players[id].isAlive) 
                        grid.innerHTML += `<button onclick="investigate('${id}', '${data.players[id].name}', '${data.players[id].role}')" class="p-3 border border-cyan-500/30 bg-cyan-500/5 rounded-xl text-[10px] font-black text-cyan-400">كشف ${data.players[id].name}</button>`;
                });
            } else { indicator.innerText = "انتظر..."; }
        } else {
            indicator.innerText = "التصويت";
            if(local.isAlive && !local.actionTaken) {
                Object.keys(data.players).forEach(id => {
                    if(data.players[id].isAlive) 
                        grid.innerHTML += `<button onclick="doAction('dayVotes', '${id}')" class="p-3 border border-white/10 bg-white/5 rounded-xl text-[10px] font-black">تصويت ضد ${data.players[id].name}</button>`;
                });
            } else if(local.actionTaken) { indicator.innerText = "VOTED"; }
        }
    }

    function investigate(id, name, role) {
        local.actionTaken = true;
        const roleAr = translateRole(role);
        notify(`تحليل رقمي: العميل ${name} هويته هي [${roleAr}]`);
        lucide.createIcons();
    }

    function doAction(path, tid) {
        local.actionTaken = true;
        db.ref(`games/${local.room}/${path}/${local.id}`).set(tid);
        notify("تم إرسال البيانات للقطاع");
    }

    function startGame() {
        db.ref(`games/${local.room}/players`).once('value', s => {
            const players = s.val(); const ids = Object.keys(players);
            let roles = ['Mafia', 'Doctor', 'Detective'];
            while(roles.length < ids.length) roles.push('Citizen');
            roles.sort(() => Math.random() - 0.5);
            const up = { status: 'assigning' };
            ids.forEach((id, i) => up[`players/${id}/role`] = roles[i]);
            db.ref(`games/${local.room}`).update(up).then(() => {
                setTimeout(() => db.ref(`games/${local.room}`).update({ status: 'night', nightActions: { init: true }, nightVotes: { init: true } }), 6000);
            });
        });
    }

    function checkLoop(data) {
        const players = Object.values(data.players);
        const alive = players.filter(p => p.isAlive);
        if(data.status === 'night') {
            const mafiaCount = alive.filter(p => p.role === 'Mafia').length;
            const votesCount = data.nightVotes ? Object.keys(data.nightVotes).length - 1 : 0;
            const hasDoc = alive.some(p => p.role === 'Doctor');
            const docDone = !hasDoc || (data.nightActions && data.nightActions.heal);
            if(votesCount >= mafiaCount && docDone) {
                const vArr = Object.values(data.nightVotes).filter(v => v !== true);
                if(vArr.length > 0) {
                    const freq = {}; vArr.forEach(v => freq[v] = (freq[v] || 0) + 1);
                    const victimId = Object.keys(freq).reduce((a,b) => freq[a] > freq[b] ? a : b);
                    let resultMsg = "الليلة هادئة في نيوم..";
                    if(victimId !== data.nightActions?.heal) {
                        db.ref(`games/${local.room}/players/${victimId}`).update({ isAlive: false });
                        resultMsg = `تم اختراق تكنولوجيا العميل ${data.players[victimId].name} وتصفيته!`;
                    } else { resultMsg = "تم إحباط محاولة اغتيال الليلة بفضل الطبيب!"; }
                    db.ref(`games/${local.room}`).update({ status: 'day', dayVotes: { init: true }, nightVotes: { init: true }, nightActions: { init: true } });
                    sendSystemMsg(resultMsg);
                } else {
                    db.ref(`games/${local.room}`).update({ status: 'day', dayVotes: { init: true } });
                    sendSystemMsg("لم يتم رصد أي نشاط عدائي الليلة.");
                }
            }
        } else if (data.status === 'day') {
            const votesCount = data.dayVotes ? Object.keys(data.dayVotes).length - 1 : 0;
            if(votesCount >= alive.length) {
                const vArr = Object.values(data.dayVotes).filter(v => v !== true);
                if(vArr.length > 0) {
                    const freq = {}; vArr.forEach(v => freq[v] = (freq[v] || 0) + 1);
                    const votedId = Object.keys(freq).reduce((a,b) => freq[a] > freq[b] ? a : b);
                    db.ref(`games/${local.room}/players/${votedId}`).update({ isAlive: false });
                    sendSystemMsg(`القطاع قرر عزل العميل ${data.players[votedId].name}.`);
                }
                db.ref(`games/${local.room}`).update({ status: 'night', nightVotes: { init: true }, nightActions: { init: true } });
            }
        }
    }

    function checkWin(data) {
        const players = Object.values(data.players);
        const mafia = players.filter(p => p.isAlive && p.role === 'Mafia').length;
        const citizens = players.filter(p => p.isAlive && p.role !== 'Mafia').length;
        if(mafia === 0) db.ref(`games/${local.room}`).update({ status: 'result', winner: 'المواطنين' });
        else if(mafia >= citizens) db.ref(`games/${local.room}`).update({ status: 'result', winner: 'المافيا' });
    }

    function showResult(winner) {
        const nameEl = document.getElementById('winner-name');
        const detailEl = document.getElementById('winner-detail');
        const iconEl = document.getElementById('winner-icon');
        const cardEl = document.getElementById('result-card');

        nameEl.innerText = "فوز " + winner;
        if(winner === 'المافيا') {
            nameEl.style.color = 'var(--mafia-red)';
            detailEl.innerText = "تم اختراق النظام بالكامل وسقطت المدينة بيد المافيا.";
            iconEl.setAttribute('data-lucide', 'skull');
            cardEl.style.borderColor = 'var(--mafia-red)';
        } else {
            nameEl.style.color = 'var(--neon-blue)';
            detailEl.innerText = "نجح المواطنون في استعادة السيطرة وتطهير القطاع.";
            iconEl.setAttribute('data-lucide', 'shield-check');
            cardEl.style.borderColor = 'var(--neon-blue)';
        }
        navigate('screen-result');
    }

    function sendMessage() {
        const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
        const isMafiaChat = (local.role === 'Mafia' && local.phase === 'night');
        db.ref(`games/${local.room}/messages`).push({ sender: local.name, text: txt, type: isMafiaChat?'mafia':'player', isAlive: local.isAlive });
        inp.value = '';
    }

    function sendSystemMsg(txt) { db.ref(`games/${local.room}/messages`).push({ sender: 'NEOM SYSTEM', text: txt, type: 'system', isAlive: true }); }

    function renderMsgs(msgs) {
        const box = document.getElementById('chat-box'); box.innerHTML = '';
        Object.values(msgs).forEach(m => {
            if(m.type === 'mafia' && local.role !== 'Mafia') return;
            if(!m.isAlive && local.isAlive && m.type !== 'system') return;
            const div = document.createElement('div');
            let c = m.type==='mafia'?'msg-mafia':(!m.isAlive?'msg-dead':(m.type==='system'?'msg-system':'msg-player'));
            div.className = `msg ${c}`;
            div.innerHTML = `${m.type!=='system'?`<strong class="block text-[9px] uppercase opacity-50">${m.sender}</strong>`:''} <span>${m.text}</span>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    db.ref(".info/connected").on("value", s => {
        document.getElementById('status-glow').className = s.val() ? "w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_8px_#00f3ff]" : "w-2 h-2 rounded-full bg-red-600 shadow-[0_0_8px_red]";
    });
    lucide.createIcons();
</script>
</body>
</html>
